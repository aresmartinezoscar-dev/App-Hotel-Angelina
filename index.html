<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Villa Angelina - Gesti√≥n</title>
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-database-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 10px 0;
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2em;
            margin-bottom: 5px;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .header p {
            color: #718096;
            font-size: 1em;
            font-weight: 500;
        }

        .main-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .main-btn {
            padding: 25px 20px;
            border: none;
            border-radius: 20px;
            font-size: 1.4em;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .main-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .main-btn:active::before {
            left: 100%;
        }

        .income-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 1.5em;
        }

        .expense-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 1.5em;
        }

        .main-btn:active {
            transform: scale(0.98);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .secondary-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .secondary-btn {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 15px 10px;
            border: none;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .secondary-btn:active {
            transform: scale(0.95);
        }

        .admin-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 380px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .modal-header h2 {
            color: #374151;
            font-size: 1.3em;
            font-weight: 800;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #9ca3af;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #374151;
            font-size: 0.95em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .readonly-input {
            background-color: #f3f4f6 !important;
            color: #6b7280;
            font-weight: 600;
        }

        .submit-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .success-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            display: none;
            z-index: 2000;
            animation: slideInTop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            font-weight: 600;
        }

        .error-popup {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }

        @keyframes slideInTop {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .option-btn {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .option-btn:active {
            transform: scale(0.98);
        }

        .balance-display {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            padding: 8px 0;
        }

        .balance-item.total {
            font-weight: 800;
            font-size: 1.4em;
            border-top: 2px solid #6366f1;
            padding-top: 15px;
            margin-top: 15px;
        }

        .positive { color: #10b981; font-weight: 700; }
        .negative { color: #ef4444; font-weight: 700; }

        .info-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #6366f1;
        }

        .detail-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #e5e7eb;
        }

        .detail-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9em;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item strong {
            color: #374151;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .online {
            background: #10b981;
            color: white;
        }

        .offline {
            background: #ef4444;
            color: white;
        }

        .connecting {
            background: #f59e0b;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e5e7eb;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
            font-weight: 600;
        }

        .edit-btn {
            background: #6366f1;
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .setup-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-section h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .setup-section p {
            color: #78350f;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .config-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">üîÑ Conectando...</div>
    
    <div class="container">
        <!-- Secci√≥n de configuraci√≥n de Firebase -->
        <div class="setup-section" id="setupSection">
            <h3>üîß Configuraci√≥n Requerida</h3>
            <p>Configure su base de datos Firebase para sincronizaci√≥n en tiempo real</p>
            <button class="config-btn" onclick="showFirebaseConfig()">Configurar Firebase</button>
        </div>

        <div class="header">
            <h1>üè® Hotel Villa Angelina</h1>
            <p>Gesti√≥n en Tiempo Real</p>
        </div>

        <div class="main-buttons">
            <button class="main-btn income-btn" onclick="showIncomeOptions()">
                üí∞ INGRESOS
            </button>
            <button class="main-btn expense-btn" onclick="showExpenseModal()">
                üí∏ GASTOS
            </button>
        </div>

        <div class="secondary-buttons">
            <button class="secondary-btn" onclick="showBalance()">üìä Balance</button>
            <button class="secondary-btn" onclick="showResetOptions()">‚è∞ Reset</button>
        </div>

        <button class="admin-btn" onclick="showProductAdmin()">‚öôÔ∏è Editar Productos</button>
        <button class="admin-btn reset-btn" onclick="confirmReset()">üóëÔ∏è Reset Manual</button>
    </div>

    <!-- Modal de configuraci√≥n de Firebase -->
    <div id="firebaseConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configurar Firebase</h2>
                <span class="close" onclick="closeModal('firebaseConfigModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" placeholder="Tu Firebase API Key">
            </div>
            <div class="form-group">
                <label for="databaseURL">Database URL:</label>
                <input type="text" id="databaseURL" placeholder="https://tu-proyecto.firebaseio.com/">
            </div>
            <div class="form-group">
                <label for="projectId">Project ID:</label>
                <input type="text" id="projectId" placeholder="tu-proyecto-id">
            </div>
            <button class="submit-btn" onclick="saveFirebaseConfig()">üíæ Guardar Configuraci√≥n</button>
            <div style="margin-top: 15px; padding: 15px; background: #f3f4f6; border-radius: 10px; font-size: 0.85em;">
                <strong>üìã Instrucciones:</strong><br>
                1. Ve a <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a><br>
                2. Crea un proyecto nuevo<br>
                3. Activa Realtime Database<br>
                4. Copia las credenciales desde Project Settings
            </div>
        </div>
    </div>

    <!-- Resto de modales (igual que antes) -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tipo de Ingreso</h2>
                <span class="close" onclick="closeModal('incomeModal')">&times;</span>
            </div>
            <button class="option-btn" onclick="showGuestForm()">üë§ Registrar Hu√©sped</button>
            <button class="option-btn" onclick="showSaleForm()">üõí Registrar Venta</button>
        </div>
    </div>

    <div id="guestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Hu√©sped</h2>
                <span class="close" onclick="closeModal('guestModal')">&times;</span>
            </div>
            <form id="guestForm">
                <div class="form-group">
                    <label for="guestName">Nombre del Hu√©sped:</label>
                    <input type="text" id="guestName" required>
                </div>
                <div class="form-group">
                    <label for="roomNumber">N√∫mero de Habitaci√≥n:</label>
                    <input type="text" id="roomNumber" placeholder="Ej: 101, 205..." required>
                </div>
                <div class="form-group">
                    <label for="checkIn">Fecha de Entrada:</label>
                    <input type="date" id="checkIn" required>
                </div>
                <div class="form-group">
                    <label for="checkOut">Fecha de Salida:</label>
                    <input type="date" id="checkOut" required>
                </div>
                <div class="form-group">
                    <label for="guestPrice">Precio de la Estancia (COP):</label>
                    <input type="number" id="guestPrice" min="0" required>
                </div>
                <button type="submit" class="submit-btn">Registrar Hu√©sped</button>
            </form>
        </div>
    </div>

    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Venta</h2>
                <span class="close" onclick="closeModal('saleModal')">&times;</span>
            </div>
            <form id="saleForm">
                <div class="form-group">
                    <label for="product">Producto:</label>
                    <select id="product" required>
                        <option value="">Selecciona un producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Cantidad:</label>
                    <input type="number" id="quantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="salePrice">Precio Unitario (COP):</label>
                    <input type="number" id="salePrice" min="0" readonly class="readonly-input">
                </div>
                <div class="form-group">
                    <label for="totalPrice">Total (COP):</label>
                    <input type="number" id="totalPrice" readonly class="readonly-input">
                </div>
                <button type="submit" class="submit-btn">Registrar Venta</button>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Gasto</h2>
                <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseConcept">Concepto:</label>
                    <input type="text" id="expenseConcept" placeholder="Ej: Mantenimiento, Compras..." required>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Cantidad (COP):</label>
                    <input type="number" id="expenseAmount" min="0" required>
                </div>
                <div class="form-group">
                    <label for="expenseDate">Fecha:</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label for="expenseDescription">Descripci√≥n (opcional):</label>
                    <textarea id="expenseDescription" rows="3" placeholder="Detalles adicionales..."></textarea>
                </div>
                <button type="submit" class="submit-btn">Registrar Gasto</button>
            </form>
        </div>
    </div>

    <div id="balanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Balance General</h2>
                <span class="close" onclick="closeModal('balanceModal')">&times;</span>
            </div>
            <div id="balanceContent"></div>
        </div>
    </div>

    <div id="productAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Administrar Productos</h2>
                <span class="close" onclick="closeModal('productAdminModal')">&times;</span>
            </div>
            
            <div class="form-group">
                <h3 style="margin-bottom: 15px;">A√±adir Nuevo Producto</h3>
                <input type="text" id="newProductName" placeholder="Nombre del producto">
                <input type="number" id="newProductPrice" placeholder="Precio en COP" style="margin-top: 10px;">
                <button class="submit-btn" onclick="addNewProduct()" style="margin-top: 10px;">A√±adir Producto</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Productos Existentes</h3>
                <div id="productsList"></div>
            </div>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Producto</h2>
                <span class="close" onclick="closeModal('editProductModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="editProductName">Nombre:</label>
                <input type="text" id="editProductName">
            </div>
            <div class="form-group">
                <label for="editProductPrice">Precio (COP):</label>
                <input type="number" id="editProductPrice">
            </div>
            <button class="submit-btn" onclick="saveProductEdit()">Guardar Cambios</button>
        </div>
    </div>

    <div id="resetOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Programar Reset</h2>
                <span class="close" onclick="closeModal('resetOptionsModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="resetFrequency">Frecuencia:</label>
                <select id="resetFrequency">
                    <option value="none">Sin reset autom√°tico</option>
                    <option value="weekly">Semanal (lunes)</option>
                    <option value="monthly">Mensual (d√≠a 1)</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            <div id="customResetDate" style="display: none;">
                <div class="form-group">
                    <label for="resetDay">D√≠a del mes:</label>
                    <input type="number" id="resetDay" min="1" max="31">
                </div>
            </div>
            <button class="submit-btn" onclick="saveResetSettings()">Guardar Configuraci√≥n</button>
        </div>
    </div>

    <div id="successPopup" class="success-popup">
        <span id="successMessage">‚úÖ Operaci√≥n completada</span>
    </div>

    <script>
        // Variables globales
        let database = null;
        let isFirebaseConfigured = false;
        let hotelData = {
            guests: [],
            sales: [],
            expenses: [],
            products: {},
            lastReset: new Date().toISOString(),
            resetSettings: {
                frequency: 'none',
                customDay: null,
                nextReset: null
            }
        };

        // Productos iniciales
        const initialProducts = {
            "Agua brisa 600mL": 2000,
            "Agua cristal 300mL": 800,
            "Arranca muela": 200,
            "Chao": 100,
            "Choki": 2000,
            "Coca cola 1.5L": 7000,
            "Coca cola 400ml": 3000,
            "Cola roman 1.5L": 5000,
            "Colgate peque√±o": 2500,
            "Desodorante balan": 1500,
            "Detodito": 3000,
            "Dorito": 2800,
            "Jugo del valle 1.5L": 5000,
            "Mamut": 500,
            "Manimoto cronch": 1800,
            "Man√≠ moto salado": 1200,
            "Margaritas": 2800,
            "Pan ali√±ado": 1000,
            "Pan de queso": 1000,
            "Savital acondicionador": 1500,
            "Savital shampo": 1500,
            "Sepillo de diente": 2000,
            "S√∫per coco": 200
        };

        let currentEditingProduct = null;

        // Inicializaci√≥n
        function init() {
            loadFirebaseConfig();
            loadLocalData();
            loadProducts();
            setCurrentDate();
        }

        // Configuraci√≥n de Firebase
        function loadFirebaseConfig() {
            const config = localStorage.getItem('firebaseConfig');
            if (config) {
                const firebaseConfig = JSON.parse(config);
                initializeFirebase(firebaseConfig);
                document.getElementById('setupSection').style.display = 'none';
            } else {
                updateConnectionStatus('config');
            }
        }

        function showFirebaseConfig() {
            document.getElementById('firebaseConfigModal').style.display = 'block';
        }

        function saveFirebaseConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const databaseURL = document.getElementById('databaseURL').value.trim();
            const projectId = document.getElementById('projectId').value.trim();

            if (!apiKey || !databaseURL || !projectId) {
                showError('Por favor, completa todos los campos de configuraci√≥n');
                return;
            }

        function saveFirebaseConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const databaseURL = document.getElementById('databaseURL').value.trim();
            const projectId = document.getElementById('projectId').value.trim();

            if (!apiKey || !databaseURL || !projectId) {
                showError('Por favor, completa todos los campos de configuraci√≥n');
                return;
            }

            const firebaseConfig = {
                apiKey: apiKey,
                authDomain: `${projectId}.firebaseapp.com`,
                databaseURL: databaseURL,
                projectId: projectId,
                storageBucket: `${projectId}.appspot.com`,
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef123456789"
            };

            localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
            initializeFirebase(firebaseConfig);
            closeModal('firebaseConfigModal');
            document.getElementById('setupSection').style.display = 'none';
            showSuccess('‚úÖ Firebase configurado correctamente');
        }

        function initializeFirebase(config) {
            try {
                firebase.initializeApp(config);
                database = firebase.database();
                isFirebaseConfigured = true;
                updateConnectionStatus('online');
                
                // Escuchar cambios en tiempo real
                listenToFirebaseChanges();
                
                // Cargar datos iniciales
                loadDataFromFirebase();
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateConnectionStatus('error');
                showError('Error al conectar con Firebase. Verifica la configuraci√≥n.');
            }
        }

        function listenToFirebaseChanges() {
            if (!database) return;

            // Escuchar cambios en tiempo real
            database.ref('hotelData').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    hotelData = { ...hotelData, ...data };
                    loadProducts();
                    updateConnectionStatus('online');
                }
            });

            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    updateConnectionStatus('online');
                } else {
                    updateConnectionStatus('offline');
                }
            });
        }

        function loadDataFromFirebase() {
            if (!database) return;

            database.ref('hotelData').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        hotelData = { ...hotelData, ...snapshot.val() };
                    } else {
                        // Primera vez - inicializar con productos por defecto
                        hotelData.products = { ...initialProducts };
                        saveDataToFirebase();
                    }
                    loadProducts();
                })
                .catch((error) => {
                    console.error('Error cargando datos:', error);
                    showError('Error al cargar datos de Firebase');
                });
        }

        function saveDataToFirebase() {
            if (!database) {
                saveLocalData();
                return;
            }

            database.ref('hotelData').set(hotelData)
                .then(() => {
                    // Datos guardados exitosamente
                })
                .catch((error) => {
                    console.error('Error guardando datos:', error);
                    showError('Error al sincronizar datos');
                    saveLocalData(); // Fallback local
                });
        }

        // Funciones de datos locales (fallback)
        function loadLocalData() {
            const saved = localStorage.getItem('hotelVillaAngelina');
            if (saved) {
                const localData = JSON.parse(saved);
                hotelData = { ...hotelData, ...localData };
            }
            
            if (!hotelData.products || Object.keys(hotelData.products).length === 0) {
                hotelData.products = { ...initialProducts };
                saveLocalData();
            }
        }

        function saveLocalData() {
            localStorage.setItem('hotelVillaAngelina', JSON.stringify(hotelData));
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'online':
                    statusEl.className = 'connection-status online';
                    statusEl.innerHTML = 'üåê En L√≠nea';
                    break;
                case 'offline':
                    statusEl.className = 'connection-status offline';
                    statusEl.innerHTML = 'üì± Sin Conexi√≥n';
                    break;
                case 'config':
                    statusEl.className = 'connection-status connecting';
                    statusEl.innerHTML = '‚öôÔ∏è Config Requerida';
                    break;
                case 'error':
                    statusEl.className = 'connection-status offline';
                    statusEl.innerHTML = '‚ùå Error Conexi√≥n';
                    break;
                default:
                    statusEl.className = 'connection-status connecting';
                    statusEl.innerHTML = 'üîÑ Conectando...';
            }
        }

        // Funciones de utilidad
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const checkIn = document.getElementById('checkIn');
            const expenseDate = document.getElementById('expenseDate');
            if (checkIn) checkIn.value = today;
            if (expenseDate) expenseDate.value = today;
        }

        function loadProducts() {
            const productSelect = document.getElementById('product');
            if (!productSelect) return;
            
            productSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            
            const sortedProducts = Object.keys(hotelData.products).sort();
            sortedProducts.forEach(productName => {
                const option = document.createElement('option');
                option.value = productName;
                option.textContent = `${productName} - ${formatCurrency(hotelData.products[productName])}`;
                productSelect.appendChild(option);
            });
        }

        function showSuccess(message = '‚úÖ Operaci√≥n completada') {
            const popup = document.getElementById('successPopup');
            const messageEl = document.getElementById('successMessage');
            popup.className = 'success-popup';
            messageEl.textContent = message;
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const popup = document.getElementById('successPopup');
            const messageEl = document.getElementById('successMessage');
            popup.className = 'success-popup error-popup';
            messageEl.textContent = `‚ùå ${message}`;
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 4000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Funciones de navegaci√≥n
        function showIncomeOptions() {
            document.getElementById('incomeModal').style.display = 'block';
        }

        function showGuestForm() {
            closeModal('incomeModal');
            document.getElementById('guestModal').style.display = 'block';
            setCurrentDate();
        }

        function showSaleForm() {
            closeModal('incomeModal');
            document.getElementById('saleModal').style.display = 'block';
            loadProducts();
        }

        function showExpenseModal() {
            document.getElementById('expenseModal').style.display = 'block';
            setCurrentDate();
        }

        function showProductAdmin() {
            document.getElementById('productAdminModal').style.display = 'block';
            displayProductsList();
        }

        function showResetOptions() {
            document.getElementById('resetOptionsModal').style.display = 'block';
            document.getElementById('resetFrequency').value = hotelData.resetSettings.frequency;
            
            if (hotelData.resetSettings.frequency === 'custom') {
                document.getElementById('customResetDate').style.display = 'block';
                document.getElementById('resetDay').value = hotelData.resetSettings.customDay || '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Manejo de formularios
        function setupFormHandlers() {
            // Formulario de hu√©sped
            document.getElementById('guestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div> Guardando...';
                
                const guest = {
                    id: Date.now(),
                    name: document.getElementById('guestName').value,
                    room: document.getElementById('roomNumber').value,
                    checkIn: document.getElementById('checkIn').value,
                    checkOut: document.getElementById('checkOut').value,
                    price: parseInt(document.getElementById('guestPrice').value),
                    date: new Date().toISOString()
                };
                
                hotelData.guests.push(guest);
                
                if (isFirebaseConfigured) {
                    saveDataToFirebase();
                } else {
                    saveLocalData();
                }
                
                closeModal('guestModal');
                showSuccess('‚úÖ Hu√©sped registrado correctamente');
                this.reset();
                setCurrentDate();
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Registrar Hu√©sped';
            });

            // Formulario de venta
            document.getElementById('saleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div> Guardando...';
                
                const sale = {
                    id: Date.now(),
                    product: document.getElementById('product').value,
                    quantity: parseInt(document.getElementById('quantity').value),
                    unitPrice: parseInt(document.getElementById('salePrice').value),
                    total: parseInt(document.getElementById('totalPrice').value),
                    date: new Date().toISOString()
                };
                
                hotelData.sales.push(sale);
                
                if (isFirebaseConfigured) {
                    saveDataToFirebase();
                } else {
                    saveLocalData();
                }
                
                closeModal('saleModal');
                showSuccess('‚úÖ Venta registrada correctamente');
                this.reset();
                document.getElementById('quantity').value = '1';
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Registrar Venta';
            });

            // Formulario de gasto
            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div> Guardando...';
                
                const expense = {
                    id: Date.now(),
                    concept: document.getElementById('expenseConcept').value,
                    amount: parseInt(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    description: document.getElementById('expenseDescription').value,
                    timestamp: new Date().toISOString()
                };
                
                hotelData.expenses.push(expense);
                
                if (isFirebaseConfigured) {
                    saveDataToFirebase();
                } else {
                    saveLocalData();
                }
                
                closeModal('expenseModal');
                showSuccess('‚úÖ Gasto registrado correctamente');
                this.reset();
                setCurrentDate();
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Registrar Gasto';
            });

            // Manejar cambio de producto
            document.getElementById('product').addEventListener('change', function() {
                const productName = this.value;
                if (productName && hotelData.products[productName]) {
                    document.getElementById('salePrice').value = hotelData.products[productName];
                    calculateTotal();
                }
            });
            
            document.getElementById('quantity').addEventListener('input', calculateTotal);

            // Manejar cambio de frecuencia de reset
            document.getElementById('resetFrequency').addEventListener('change', function() {
                const customDiv = document.getElementById('customResetDate');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                }
            });
        }

        function calculateTotal() {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const price = parseInt(document.getElementById('salePrice').value) || 0;
            const total = quantity * price;
            document.getElementById('totalPrice').value = total;
        }

        // Balance y reportes
        function showBalance() {
            const totalGuests = hotelData.guests.reduce((sum, guest) => sum + guest.price, 0);
            const totalSales = hotelData.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalExpenses = hotelData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalIncome = totalGuests + totalSales;
            const balance = totalIncome - totalExpenses;
            
            const content = `
                <div class="balance-display">
                    <div class="balance-item">
                        <span>Ingresos por Hu√©spedes:</span>
                        <span class="positive">${formatCurrency(totalGuests)}</span>
                    </div>
                    <div class="balance-item">
                        <span>Ingresos por Ventas:</span>
                        <span class="positive">${formatCurrency(totalSales)}</span>
                    </div>
                    <div class="balance-item">
                        <span>Total Ingresos:</span>
                        <span class="positive">${formatCurrency(totalIncome)}</span>
                    </div>
                    <div class="balance-item">
                        <span>Total Gastos:</span>
                        <span class="negative">${formatCurrency(totalExpenses)}</span>
                    </div>
                    <div class="balance-item total">
                        <span>Balance Final:</span>
                        <span class="${balance >= 0 ? 'positive' : 'negative'}">${formatCurrency(balance)}</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3 style="margin-bottom: 10px; color: #374151;">üìä Resumen de Actividad</h3>
                    <p><strong>Hu√©spedes registrados:</strong> ${hotelData.guests.length}</p>
                    <p><strong>Ventas realizadas:</strong> ${hotelData.sales.length}</p>
                    <p><strong>Gastos registrados:</strong> ${hotelData.expenses.length}</p>
                    <p><strong>√öltimo reset:</strong> ${new Date(hotelData.lastReset).toLocaleDateString('es-CO')}</p>
                    <p><strong>Estado:</strong> ${isFirebaseConfigured ? 'üåê Sincronizado' : 'üì± Solo local'}</p>
                </div>
                
                <button class="submit-btn" onclick="showDetailedInfo()" style="margin-top: 15px;">
                    üìã Ver Informaci√≥n Detallada
                </button>
            `;
            
            document.getElementById('balanceContent').innerHTML = content;
            document.getElementById('balanceModal').style.display = 'block';
        }

        function showDetailedInfo() {
            let detailContent = '<div style="margin-top: 20px;">';
            
            // Detalles de hu√©spedes
            detailContent += '<h3 style="color: #374151; margin-bottom: 15px;">üë• Hu√©spedes Registrados</h3>';
            if (hotelData.guests.length > 0) {
                detailContent += '<div class="detail-list">';
                hotelData.guests.slice(-10).reverse().forEach(guest => {
                    detailContent += `
                        <div class="detail-item">
                            <strong>${guest.name}</strong> - Habitaci√≥n ${guest.room}<br>
                            <small>Entrada: ${guest.checkIn} | Salida: ${guest.checkOut}</small><br>
                            <span class="positive">${formatCurrency(guest.price)}</span>
                        </div>
                    `;
                });
                detailContent += '</div>';
            } else {
                detailContent += '<p style="color: #6b7280; font-style: italic;">No hay hu√©spedes registrados</p>';
            }

            // Detalles de ventas
            detailContent += '<h3 style="color: #374151; margin: 20px 0 15px 0;">üõí Ventas Recientes</h3>';
            if (hotelData.sales.length > 0) {
                detailContent += '<div class="detail-list">';
                hotelData.sales.slice(-10).reverse().forEach(sale => {
                    detailContent += `
                        <div class="detail-item">
                            <strong>${sale.product}</strong><br>
                            <small>Cantidad: ${sale.quantity} | Precio unitario: ${formatCurrency(sale.unitPrice)}</small><br>
                            <span class="positive">Total: ${formatCurrency(sale.total)}</span>
                        </div>
                    `;
                });
                detailContent += '</div>';
            } else {
                detailContent += '<p style="color: #6b7280; font-style: italic;">No hay ventas registradas</p>';
            }

            // Detalles de gastos
            detailContent += '<h3 style="color: #374151; margin: 20px 0 15px 0;">üí∏ Gastos Recientes</h3>';
            if (hotelData.expenses.length > 0) {
                detailContent += '<div class="detail-list">';
                hotelData.expenses.slice(-10).reverse().forEach(expense => {
                    detailContent += `
                        <div class="detail-item">
                            <strong>${expense.concept}</strong><br>
                            <small>Fecha: ${expense.date}</small><br>
                            ${expense.description ? `<small>${expense.description}</small><br>` : ''}
                            <span class="negative">${formatCurrency(expense.amount)}</span>
                        </div>
                    `;
                });
                detailContent += '</div>';
            } else {
                detailContent += '<p style="color: #6b7280; font-style: italic;">No hay gastos registrados</p>';
            }

            detailContent += '</div>';
            document.getElementById('balanceContent').innerHTML += detailContent;
        }

        // Administraci√≥n de productos
        function displayProductsList() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            
            const sortedProducts = Object.keys(hotelData.products).sort();
            sortedProducts.forEach(productName => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                productDiv.innerHTML = `
                    <div>
                        <strong>${productName}</strong><br>
                        <small>${formatCurrency(hotelData.products[productName])}</small>
                    </div>
                    <div class="product-actions">
                        <button class="edit-btn" onclick="editProduct('${productName}')">‚úèÔ∏è Editar</button>
                        <button class="delete-btn" onclick="deleteProduct('${productName}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                productsList.appendChild(productDiv);
            });
        }

        function addNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseInt(document.getElementById('newProductPrice').value);
            
            if (!name || !price || price < 0) {
                showError('Por favor, completa todos los campos correctamente');
                return;
            }
            
            if (hotelData.products[name]) {
                showError('Ya existe un producto con ese nombre');
                return;
            }
            
            hotelData.products[name] = price;
            
            if (isFirebaseConfigured) {
                saveDataToFirebase();
            } else {
                saveLocalData();
            }
            
            loadProducts();
            displayProductsList();
            
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            showSuccess('‚úÖ Producto a√±adido correctamente');
        }

        function editProduct(productName) {
            currentEditingProduct = productName;
            document.getElementById('editProductName').value = productName;
            document.getElementById('editProductPrice').value = hotelData.products[productName];
            closeModal('productAdminModal');
            document.getElementById('editProductModal').style.display = 'block';
        }

        function saveProductEdit() {
            const oldName = currentEditingProduct;
            const newName = document.getElementById('editProductName').value.trim();
            const newPrice = parseInt(document.getElementById('editProductPrice').value);
            
            if (!newName || !newPrice || newPrice < 0) {
                showError('Por favor, completa todos los campos correctamente');
                return;
            }
            
            if (newName !== oldName && hotelData.products[newName]) {
                showError('Ya existe un producto con ese nombre');
                return;
            }
            
            if (newName !== oldName) {
                delete hotelData.products[oldName];
            }
            
            hotelData.products[newName] = newPrice;
            
            if (isFirebaseConfigured) {
                saveDataToFirebase();
            } else {
                saveLocalData();
            }
            
            loadProducts();
            closeModal('editProductModal');
            showProductAdmin();
            showSuccess('‚úÖ Producto actualizado correctamente');
        }

        function deleteProduct(productName) {
            if (confirm(`¬øEst√°s seguro de eliminar "${productName}"?`)) {
                delete hotelData.products[productName];
                
                if (isFirebaseConfigured) {
                    saveDataToFirebase();
                } else {
                    saveLocalData();
                }
                
                loadProducts();
                displayProductsList();
                showSuccess('‚úÖ Producto eliminado correctamente');
            }
        }

        // Configuraci√≥n de reset
        function saveResetSettings() {
            const frequency = document.getElementById('resetFrequency').value;
            const customDay = frequency === 'custom' ? parseInt(document.getElementById('resetDay').value) : null;
            
            hotelData.resetSettings = {
                frequency: frequency,
                customDay: customDay,
                nextReset: null
            };
            
            updateNextResetDate();
            
            if (isFirebaseConfigured) {
                saveDataToFirebase();
            } else {
                saveLocalData();
            }
            
            closeModal('resetOptionsModal');
            showSuccess('‚úÖ Configuraci√≥n de reset guardada');
        }

        function updateNextResetDate() {
            const settings = hotelData.resetSettings;
            const now = new Date();
            
            if (settings.frequency === 'weekly') {
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + (1 + 7 - now.getDay()) % 7);
                if (nextMonday <= now) nextMonday.setDate(nextMonday.getDate() + 7);
                settings.nextReset = nextMonday.toISOString();
            } else if (settings.frequency === 'monthly') {
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                settings.nextReset = nextMonth.toISOString();
            } else if (settings.frequency === 'custom' && settings.customDay) {
                const nextReset = new Date(now.getFullYear(), now.getMonth(), settings.customDay);
                if (nextReset <= now) {
                    nextReset.setMonth(nextReset.getMonth() + 1);
                }
                settings.nextReset = nextReset.toISOString();
            }
        }

        function confirmReset() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de resetear todos los datos?\n\nEsta acci√≥n eliminar√°:\n- Todos los hu√©spedes\n- Todas las ventas\n- Todos los gastos\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER')) {
                hotelData.guests = [];
                hotelData.sales = [];
                hotelData.expenses = [];
                hotelData.lastReset = new Date().toISOString();
                
                if (isFirebaseConfigured) {
                    saveDataToFirebase();
                } else {
                    saveLocalData();
                }
                
                showSuccess('‚úÖ Datos reseteados correctamente');
            }
        }

        // Event handlers
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Inicializar cuando se carga la p√°gina
        window.onload = function() {
            init();
            setupFormHandlers();
        }
    </script>
</body>
</html>